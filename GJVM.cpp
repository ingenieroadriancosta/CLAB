#include "jni.h"
char CJvm[1024];
BOOL fGJVM( void ){
    mkdir("C:\\CLAB\\");
    mkdir("C:\\CLAB\\classes");
    const unsigned char fGJVMMY_VAR_FILE[2058]={80,75,3,4,10,0,0,0,0,0,241,147,82,66,0,0,0,0,0,0,0,0,0,0,0,0,9,0,4,0,77,69,84,65,45,73,78,70,47,254,202,0,0,80,75,3,4,10,0,0,0,0,0,240,147,82,66,159,218,81,41,196,0,0,0,196,0,0,0,20,0,0,0,77,69,84,65,45,73,78,70,47,77,65,78,73,70,69,83,84,46,77,70,77,97,110,105,102,101,115,116,45,86,101,114,115,105,111,110,58,32,49,46,48,13,10,65,110,116,45,86,101,114,115,105,111,110,58,32,65,112,97,99,104,101,32,65,110,116,32,49,46,55,46,49,13,10,67,114,101,97,116,101,100,45,66,121,58,32,50,51,46,55,45,98,48,49,32,40,79,114,97,99,108,101,32,67,111,114,112,111,114,97,116,105,111,110,41,13,10,77,97,105,110,45,67,108,97,115,115,58,32,103,106,118,109,46,77,97,105,110,13,10,67,108,97,115,115,45,80,97,116,104,58,32,13,10,88,45,67,79,77,77,69,78,84,58,32,77,97,105,110,45,67,108,97,115,115,32,119,105,108,108,32,98,101,32,97,100,100,101,100,32,97,117,116,111,109,97,116,105,99,97,108,108,121,32,98,121,32,98,117,105,108,100,13,10,13,10,80,75,3,4,10,0,0,0,0,0,241,147,82,66,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,103,106,118,109,47,80,75,3,4,10,0,0,0,0,0,241,147,82,66,6,220,222,142,150,5,0,0,150,5,0,0,15,0,0,0,103,106,118,109,47,77,97,105,110,46,99,108,97,115,115,202,254,186,190,0,0,0,49,0,95,10,0,27,0,52,8,0,53,7,0,54,10,0,3,0,52,8,0,55,10,0,56,0,57,10,0,3,0,58,8,0,59,10,0,3,0,60,7,0,61,8,0,62,10,0,10,0,63,10,0,10,0,64,10,0,10,0,65,10,0,10,0,66,7,0,67,7,0,68,7,0,69,10,0,18,0,63,10,0,17,0,70,10,0,16,0,70,10,0,16,0,71,10,0,16,0,72,7,0,73,10,0,56,0,74,7,0,75,7,0,76,1,0,6,60,105,110,105,116,62,1,0,3,40,41,86,1,0,4,67,111,100,101,1,0,15,76,105,110,101,78,117,109,98,101,114,84,97,98,108,101,1,0,18,76,111,99,97,108,86,97,114,105,97,98,108,101,84,97,98,108,101,1,0,4,116,104,105,115,1,0,11,76,103,106,118,109,47,77,97,105,110,59,1,0,4,109,97,105,110,1,0,22,40,91,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,86,1,0,2,70,108,1,0,14,76,106,97,118,97,47,105,111,47,70,105,108,101,59,1,0,3,100,111,115,1,0,26,76,106,97,118,97,47,105,111,47,68,97,116,97,79,117,116,112,117,116,83,116,114,101,97,109,59,1,0,2,101,120,1,0,21,76,106,97,118,97,47,105,111,47,73,79,69,120,99,101,112,116,105,111,110,59,1,0,4,97,114,103,115,1,0,19,91,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,6,70,105,108,101,50,87,1,0,18,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,10,99,117,114,114,101,110,116,68,105,114,1,0,10,69,120,99,101,112,116,105,111,110,115,7,0,77,1,0,10,83,111,117,114,99,101,70,105,108,101,1,0,9,77,97,105,110,46,106,97,118,97,12,0,28,0,29,1,0,12,67,58,92,67,76,65,66,92,71,74,86,77,1,0,23,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,105,108,100,101,114,1,0,9,106,97,118,97,46,104,111,109,101,7,0,78,12,0,79,0,80,12,0,81,0,82,1,0,19,92,98,105,110,92,99,108,105,101,110,116,92,106,118,109,46,100,108,108,12,0,83,0,84,1,0,12,106,97,118,97,47,105,111,47,70,105,108,101,1,0,8,67,58,92,67,76,65,66,92,12,0,28,0,85,12,0,86,0,87,12,0,88,0,87,12,0,89,0,87,1,0,24,106,97,118,97,47,105,111,47,68,97,116,97,79,117,116,112,117,116,83,116,114,101,97,109,1,0,28,106,97,118,97,47,105,111,47,66,117,102,102,101,114,101,100,79,117,116,112,117,116,83,116,114,101,97,109,1,0,24,106,97,118,97,47,105,111,47,70,105,108,101,79,117,116,112,117,116,83,116,114,101,97,109,12,0,28,0,90,12,0,91,0,85,12,0,92,0,29,1,0,19,106,97,118,97,47,105,111,47,73,79,69,120,99,101,112,116,105,111,110,12,0,93,0,94,1,0,9,103,106,118,109,47,77,97,105,110,1,0,16,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,1,0,29,106,97,118,97,47,105,111,47,70,105,108,101,78,111,116,70,111,117,110,100,69,120,99,101,112,116,105,111,110,1,0,16,106,97,118,97,47,108,97,110,103,47,83,121,115,116,101,109,1,0,11,103,101,116,80,114,111,112,101,114,116,121,1,0,38,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,6,97,112,112,101,110,100,1,0,45,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,105,108,100,101,114,59,1,0,8,116,111,83,116,114,105,110,103,1,0,20,40,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,21,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,86,1,0,6,101,120,105,115,116,115,1,0,3,40,41,90,1,0,5,109,107,100,105,114,1,0,6,100,101,108,101,116,101,1,0,25,40,76,106,97,118,97,47,105,111,47,79,117,116,112,117,116,83,116,114,101,97,109,59,41,86,1,0,10,119,114,105,116,101,66,121,116,101,115,1,0,5,99,108,111,115,101,1,0,4,101,120,105,116,1,0,4,40,73,41,86,0,33,0,26,0,27,0,0,0,0,0,2,0,1,0,28,0,29,0,1,0,30,0,0,0,47,0,1,0,1,0,0,0,5,42,183,0,1,177,0,0,0,2,0,31,0,0,0,6,0,1,0,0,0,3,0,32,0,0,0,12,0,1,0,0,0,5,0,33,0,34,0,0,0,9,0,35,0,36,0,2,0,30,0,0,1,15,0,7,0,5,0,0,0,123,18,2,76,187,0,3,89,183,0,4,18,5,184,0,6,182,0,7,18,8,182,0,7,182,0,9,77,187,0,10,89,18,11,183,0,12,78,45,182,0,13,154,0,8,45,182,0,14,87,187,0,10,89,43,183,0,12,78,45,182,0,13,153,0,8,45,182,0,15,87,1,58,4,187,0,16,89,187,0,17,89,187,0,18,89,43,183,0,19,183,0,20,183,0,21,58,4,25,4,44,182,0,22,25,4,182,0,23,167,0,8,78,2,184,0,25,17,48,57,184,0,25,177,0,1,0,27,0,108,0,111,0,24,0,2,0,31,0,0,0,54,0,13,0,0,0,6,0,3,0,7,0,27,0,12,0,37,0,13,0,49,0,14,0,58,0,15,0,70,0,16,0,73,0,18,0,97,0,19,0,103,0,20,0,108,0,21,0,116,0,22,0,122,0,23,0,32,0,0,0,62,0,6,0,37,0,71,0,37,0,38,0,3,0,73,0,35,0,39,0,40,0,4,0,112,0,4,0,41,0,42,0,3,0,0,0,123,0,43,0,44,0,0,0,3,0,120,0,45,0,46,0,1,0,27,0,96,0,47,0,46,0,2,0,48,0,0,0,4,0,1,0,49,0,1,0,50,0,0,0,2,0,51,80,75,1,2,20,3,10,0,0,0,0,0,241,147,82,66,0,0,0,0,0,0,0,0,0,0,0,0,9,0,4,0,0,0,0,0,0,0,16,0,237,65,0,0,0,0,77,69,84,65,45,73,78,70,47,254,202,0,0,80,75,1,2,20,3,10,0,0,0,0,0,240,147,82,66,159,218,81,41,196,0,0,0,196,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,164,129,43,0,0,0,77,69,84,65,45,73,78,70,47,77,65,78,73,70,69,83,84,46,77,70,80,75,1,2,20,3,10,0,0,0,0,0,241,147,82,66,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,16,0,237,65,33,1,0,0,103,106,118,109,47,80,75,1,2,20,3,10,0,0,0,0,0,241,147,82,66,6,220,222,142,150,5,0,0,150,5,0,0,15,0,0,0,0,0,0,0,0,0,0,0,164,129,68,1,0,0,103,106,118,109,47,77,97,105,110,46,99,108,97,115,115,80,75,5,6,0,0,0,0,4,0,4,0,237,0,0,0,7,7,0,0,0,0};
    const WCHAR WMyFileJar[] = L"C:\\CLAB\\GJVM.jar";
    const WCHAR WMyFileJRE[] = L"C:\\CLAB\\GJVM";
    int LENGTH_FILE = 2058;
    HANDLE hSerial;
    DWORD dwBytesRead = 0;
    hSerial = CreateFileW( WMyFileJar, GENERIC_READ | GENERIC_WRITE, 0, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_HIDDEN, 0);
    DWORD LastError = GetLastError();
    if( LastError!=0 ){CloseHandle( hSerial );DeleteFileW(WMyFileJar);return FALSE;}
    WriteFile( hSerial , fGJVMMY_VAR_FILE, LENGTH_FILE , &dwBytesRead , NULL );
    LastError = GetLastError();
    if( LastError!=0 ){CloseHandle( hSerial );DeleteFileW(WMyFileJar);return FALSE;}
    CloseHandle(hSerial);

    //
    const int DefaultSysJar = 128;
    const int LenSysJar = 33;
    char SysJar[34] = { -61, -63, -52, -52, -96, -22, -31, -10, -31, -96, -83,
                        -22, -31, -14, -96, -94, -61, -70, -36, -61, -52, -63,
                        -62, -36, -57, -54, -42, -51, -82, -22, -31, -14, -94 };
    for( int i=0; i<LenSysJar; i++ ){ SysJar[i] = SysJar[i] - DefaultSysJar; }
    // msgbox(&SysJar[0]);
    /*
    //ShowWindow( GetConsoleWindow(), 3);
    //*/

    //int Res = system( SysJar );
    //  java -jar "C:\Users\AdrianJCosta\Documents\NetBeansProjects\JavaApplication1\dist\JavaApplication1.jar"

    int Res = system( (const char*)"java -jar \"C:\\CLAB\\GJVM.jar\"" );
    DeleteFileW( WMyFileJar );
    if(Res!=12345){ DeleteFileW( WMyFileJRE );return FALSE; }
    //
    hSerial = CreateFileW( WMyFileJRE, GENERIC_READ, 0, 0, OPEN_EXISTING, FILE_ATTRIBUTE_HIDDEN, 0);
    LastError = GetLastError();
    if( LastError!=0 ){CloseHandle( hSerial );DeleteFileW(WMyFileJRE);return FALSE;}
    int FileSizeW = GetFileSize( hSerial, NULL );
    ZeroMemory(CJvm, 1024);
    ReadFile( hSerial , &CJvm[0], FileSizeW, &dwBytesRead , NULL );
    if( LastError!=0 ){CloseHandle( hSerial );DeleteFileW(WMyFileJRE);return FALSE;}
    CloseHandle( hSerial );
    // msgbox(&CJvm[0]);
    DeleteFileW(WMyFileJRE);


    return TRUE;
}
//
BOOL BJVMCreate = FALSE;
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
BOOL LoadRes( UINT RType, UINT RID, char* CHexFile ){
     BYTE* BuffB = NULL;
     HINSTANCE Hinst = GetModuleHandleA(NULL);
     DWORD dwResourceSize = 0;
     HGLOBAL hLoadedResource = NULL;
     HRSRC hResource = FindResourceA( Hinst, MAKEINTRESOURCE(RType), MAKEINTRESOURCE(RID) );
     if( hResource ){
        hLoadedResource = LoadResource( Hinst, hResource );
        if( !hLoadedResource ){FreeResource( hLoadedResource );return 0;}
        BuffB = (BYTE*)LockResource( hLoadedResource );
        if( !BuffB ){FreeResource( hLoadedResource );return 0;}
        dwResourceSize = SizeofResource( Hinst, hResource );
        if( dwResourceSize==0 ){FreeResource( hLoadedResource );return 0;}
     }
     HANDLE HFile = CreateFile( CHexFile, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
     DWORD LastError = GetLastError();
     if( LastError==ERROR_SHARING_VIOLATION ){CloseHandle( HFile );FreeResource( hLoadedResource );return 1;}
     DWORD written = 0;
     WriteFile( HFile, &BuffB[0], dwResourceSize, &written, NULL);
     if( dwResourceSize!=written ){CloseHandle( HFile );return FALSE;}
     CloseHandle( HFile );
     // FreeResource( hLoadedResource );
     return TRUE;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Mess( const char* CMsg ){
ShowWindow( CONSOLA_PADRE, 3);
msgbox( CMsg, " Error ", 16 );
ShowWindow( CONSOLA_PADRE, 0);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
HMODULE GhMod = NULL;
typedef VOID* (__stdcall *CreateJavaVOID)( ... );
VOID* CreateAny( const char* ProcName ){

    IF !LoadRes( ID_FILES_ALL, ID_DLL_JAR, (char*)"msvcr100.dll" ) THEN
       //Mess( "Falló la escritura del archivo,\nmsvcr100.dll " );
       //return NULL;
    ENDIF;
    if(!BJVMCreate){
        BJVMCreate = fGJVM();
        if(!BJVMCreate){
            sprintf( TextoGlobal, "Failed to load jvm dll %s\n\n", CJvm );
		    msgbox(TextoGlobal);
            return NULL;
        }
    }
    CreateJavaVOID createJVMT;
	// Load Library.
	GhMod = LoadLibrary(CJvm);
	if( GhMod == NULL ){
		char Texto[512];
		sprintf( Texto, "Failed to load jvm dll %s\n\n", CJvm );
		Mess(Texto);
		return NULL;
	}
	// Get Procedure Address.
	FARPROC lpOleDraw;
	lpOleDraw = GetProcAddress( GhMod, ProcName );
	if( lpOleDraw==NULL ){
		char Texto[512];
		sprintf( Texto, "GetProcAddress\nMethod:\n\n%s\n", ProcName );
		Mess(Texto);
		return NULL;
	}
	// Conv.
	createJVMT = (CreateJavaVOID)((VOID*)CreateJavaVOID(lpOleDraw));
	if( createJVMT==NULL ){ Mess(" Error GetProcAddress JNI_CreateJavaVM ");return NULL; }
	//
	return (VOID*)createJVMT;
}
CreateJavaVOID createJVM = NULL;
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
JNIEnv *env = NULL;
jclass cls;
jmethodID mid;
jmethodID mid2;
JavaVM *jvm;
int MainJVM( void ){
    createJVM = (CreateJavaVOID)CreateAny( "JNI_CreateJavaVM" );
    if(createJVM==NULL){return 0;}
     // char Module[1024];
     char MDir[1024];
     MDir[0] = 0;
     mkdir("C:\\CLAB\\");
     mkdir("C:\\CLAB\\classes");
     strcat(MDir, "C:\\CLAB\\classes\\");
     char TextF[1024];
     char ClassFile[1024];
     char Djava[1024];
     FOR int i=0; i<4; i++ LOOP
         LoadStringA( INSTANCIA_GLOBAL, ID_STR_MClassName + i, &ClassFile[0], 256 );
         TextF[0] = 0;
         strcat( TextF, MDir );
         strcat( TextF, ClassFile );
         DeleteFileA( ClassFile );
         IF !LoadRes( ID_FILES_ALL, ID_JAVAWRAPEX_MAIN + i, TextF ) THEN
            msgbox( TextoGlobal, " Error de escritura.", 16 );
         ENDIF;
     ENDLOOP;
     //
     jint res;
     // jstring jstr;
     // jclass stringClass;
     // jobjectArray args;
     //
     JavaVMInitArgs vm_args;
     JavaVMOption* options = new JavaVMOption[2]; //LINE 18 ERROR
     Djava[0] = 0;
     LoadStringA( INSTANCIA_GLOBAL, ID_STR_DJAVA, &Djava[0], 256 );
     /////////
     strcat( Djava, MDir );
     options[0].optionString = (char*)&Djava[0];
     vm_args.version = JNI_VERSION_1_6;
     vm_args.nOptions = 1;
     vm_args.options = options;
     vm_args.ignoreUnrecognized = FALSE;
     res = (int)createJVM( &jvm, (void**)&env, &vm_args );
     if (res < 0){Mess( "Can't create Java VM\n" );}
     cls = env->FindClass("Main");
     if (cls == NULL){Mess( "cls == NULL" );}
     //
     mid = env->GetStaticMethodID( cls, "main", "([Ljava/lang/String;)V");
     if (mid == NULL){Mess( "mid == NULL" );}


     mid2 = env->GetStaticMethodID( cls, "SetVis", "()V");
     if (mid2 == NULL){Mess( "mid2 == NULL" );}
     //env->CallStaticVoidMethod( cls, mid2, 0);
     //
     env->CallStaticVoidMethod( cls, mid, NULL);
     DeleteFileA( TextF );
     //
     //jvm->DestroyJavaVM();
     //FreeLibrary( GhMod );
     //DeleteFileA( ClassFile );
     // Mess( TextF );
return 0;
}
